name: IRCTC Automation

on:
  workflow_dispatch:
    inputs:
      USERNAME:
        required: true
        type: string
      PASSWORD:
        required: true
        type: string
      UPI_ID:
        required: true
        type: string

jobs:
  book-ticket:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Environment
      run: sudo timedatectl set-timezone Asia/Kolkata
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install Dependencies
      run: |
        pip install -r irctc-captcha-solver/requirements.txt
        npm install
        
    - name: Run IRCTC Automation
      run: |
        # Start captcha server
        cd irctc-captcha-solver
        python3 app-server.py --host 0.0.0.0 --port 5001 &
        
        # Wait for server
        sleep 30
        
        # Run Cypress
        cd ..
        npx cypress run --browser chrome --headed
      env:
        CYPRESS_USERNAME: ${{ github.event.inputs.USERNAME }}
        CYPRESS_PASSWORD: ${{ github.event.inputs.PASSWORD }}
        CYPRESS_UPI_ID: ${{ github.event.inputs.UPI_ID }}
