name: IRCTC Automation Booking

on:
  workflow_dispatch:
    inputs:
      USERNAME:
        required: true
        type: string
        description: "Your IRCTC Username"
      PASSWORD:
        required: true
        type: string
        description: "Your IRCTC Password"
      UPI_ID:
        required: true
        type: string
        description: "Your UPI ID"

jobs:
  IRCTC-Booking:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        sudo timedatectl set-timezone Asia/Kolkata
        pip install -r irctc-captcha-solver/requirements.txt
        npm install

    - name: Start Captcha Server and Run Automation
      run: |
        # Start captcha server in background
        cd irctc-captcha-solver
        python3 app-server.py --host 0.0.0.0 --port 5001 &
        
        # Wait for server to start (models will load automatically)
        echo "Waiting for captcha server to start and load models..."
        sleep 30
        
        # Test if server is running
        curl -X POST "http://localhost:5001/extract-text" -H "Content-Type: application/json" -d '{"image": ""}' || echo "Server test failed but continuing..."
        
        # Run Cypress automation
        cd ..
        npx cypress run --browser chrome --headed
      env:
        CYPRESS_USERNAME: ${{ github.event.inputs.USERNAME }}
        CYPRESS_PASSWORD: ${{ github.event.inputs.PASSWORD }}
        CYPRESS_UPI_ID: ${{ github.event.inputs.UPI_ID }}
